NAME= ecpg
SO_MAJOR_VERSION= 2
SO_MINOR_VERSION= 6
SO_PATCHLEVEL= 2

SRCDIR= @top_srcdir@

include $(SRCDIR)/Makefile.global

PQ_INCLUDE=-I$(SRCDIR)/interfaces/libpq

PORTNAME=@PORTNAME@

ifdef KRBVERS
CFLAGS+= $(KRBFLAGS)
endif

# Shared library stuff
shlib := 
install-shlib-dep :=

ifeq ($(PORTNAME), linux)
  LINUX_ELF=@LINUX_ELF@
  ifdef LINUX_ELF
    install-shlib-dep := install-shlib
    shlib := lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION).$(SO_PATCHLEVEL)
    LDFLAGS_SL = -shared -soname lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION)
  endif
endif

ifeq ($(PORTNAME), bsd)
  ifdef BSD_SHLIB
    install-shlib-dep := install-shlib
    shlib := lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION).$(SO_PATCHLEVEL)
    LDFLAGS_SL = -x -Bshareable -Bforcearchive
    CFLAGS += $(CFLAGS_SL)
  endif
endif

ifeq ($(PORTNAME), solaris_sparc)
  install-shlib-dep := install-shlib
  shlib := lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION).$(SO_PATCHLEVEL)
  LDFLAGS_SL = -G
  CFLAGS += $(CFLAGS_SL)
endif

ifeq ($(PORTNAME), solaris_i386)
  install-shlib-dep := install-shlib
  shlib := lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION).$(SO_PATCHLEVEL)
  LDFLAGS_SL = -G
  CFLAGS += $(CFLAGS_SL)
endif

ifeq ($(PORTNAME), svr4)
  install-shlib-dep := install-shlib
  shlib := lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION).$(SO_MINOR_VERSION).$(SO_PATCHLEVEL)
  LDFLAGS_SL = -G
  CFLAGS += $(CFLAGS_SL)
endif

ifeq ($(PORTNAME), univel)
  install-shlib-dep := install-shlib
  shlib := lib$(NAME)$(DLSUFFIX).1
  LDFLAGS_SL = -G -z text
  CFLAGS += $(CFLAGS_SL)
endif

ifeq ($(PORTNAME), unixware)
  install-shlib-dep := install-shlib
  shlib := lib$(NAME)$(DLSUFFIX).1
  LDFLAGS_SL = -G -z text
  CFLAGS += $(CFLAGS_SL)
endif

all: lib$(NAME).a $(shlib)

$(shlib): ecpglib.sho.o typename.sho.o
	$(LD) $(LDFLAGS_SL) -o $@ ecpglib.sho.o typename.sho.o

clean:
	rm -f *.o *.sho *.a core a.out *~ $(shlib) lib$(NAME)$(DLSUFFIX)

dep depend:

install: lib$(NAME).a $(shlib) $(install-shlib-dep)
	$(INSTALL) $(INSTLOPTS) lib$(NAME).a $(LIBDIR)

install-shlib:
	$(INSTALL) $(INSTLOPTS) $(shlib) $(LIBDIR)
	cd $(LIBDIR) && $(LN_S) -f $(shlib) lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION)
	cd $(LIBDIR) && $(LN_S) -f $(shlib) lib$(NAME)$(DLSUFFIX)
 

uninstall::
	rm -f $(LIBDIR)/lib$(NAME).a $(LIBDIR)/$(shlib)
	rm -f $(LIBDIR)/lib$(NAME)$(DLSUFFIX).$(SO_MAJOR_VERSION)
	rm -f $(LIBDIR)/lib$(NAME)$(DLSUFFIX)

# Rules that do something
lib$(NAME).a : lib$(NAME).a(ecpglib.o) lib$(NAME).a(typename.o)

ecpglib.o : ecpglib.c ../include/ecpglib.h ../include/ecpgtype.h
	$(CC) $(CFLAGS) -I../include $(PQ_INCLUDE) -c $< -o $@
typename.o : typename.c ../include/ecpgtype.h
	$(CC) $(CFLAGS) -I../include $(PQ_INCLUDE) -c $< -o $@

ecpglib.sho : ecpglib.c ../include/ecpglib.h ../include/ecpgtype.h
	$(CC) $(CFLAGS) $(CFLAGS_SL) -I../include $(PQ_INCLUDE) -c $< -o $@
typename.sho : typename.c ../include/ecpgtype.h
	$(CC) $(CFLAGS) $(CFLAGS_SL) -I../include $(PQ_INCLUDE) -c $< -o $@
